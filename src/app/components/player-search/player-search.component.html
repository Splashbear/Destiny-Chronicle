<div class="min-h-screen bg-slate-900">
  <div class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-12 gap-6">
      <!-- Left Sidebar - Account Selection -->
      <div class="col-span-12 lg:col-span-3">
        <div class="bg-slate-800/95 rounded-lg shadow-lg p-4">
          <h2 class="text-xl font-bold text-white mb-4">Accounts</h2>
          
          <!-- Selected Profiles -->
          <div class="mb-4 space-y-2">
            <div *ngFor="let player of selectedPlayers; let i = index" 
                 class="flex items-center bg-slate-700/80 rounded px-2 py-1 text-sm text-white">
              <span class="font-semibold truncate">{{ player.displayName }}</span>
              <span class="ml-1 px-1.5 py-0.5 rounded text-xs font-bold" 
                    [ngClass]="player.game === 'D1' ? 'bg-destiny-d1' : 'bg-destiny-d2'">
                {{ player.game }}
              </span>
              <span class="ml-1 text-xs text-slate-300">{{ player.platform }}</span>
              <button (click)="removePlayer(i)" 
                      class="ml-auto text-red-400 hover:text-red-200" 
                      title="Remove">Ã—</button>
            </div>
          </div>

          <!-- Compact Search Form -->
          <div class="space-y-2">
            <input type="text" 
                   [(ngModel)]="searchUsername"
                   [class.border-red-500]="errorMessage"
                   class="w-full px-3 py-1.5 text-sm bg-slate-700/95 text-white rounded border border-slate-600"
                   placeholder="Username">
            
            <div class="grid grid-cols-2 gap-2">
              <select [(ngModel)]="selectedPlatform"
                      class="w-full px-2 py-1.5 text-sm bg-slate-700/95 text-white rounded border border-slate-600">
                <option *ngFor="let platform of platforms" [value]="platform.value">
                  {{ platform.label }}
                </option>
              </select>
              
              <select [(ngModel)]="selectedGame" 
                      class="w-full px-2 py-1.5 text-sm bg-slate-700/95 text-white rounded border border-slate-600">
                <option value="D1">D1</option>
                <option value="D2">D2</option>
              </select>
            </div>

            <button (click)="addPlayer()" 
                    [disabled]="!searchUsername"
                    class="w-full bg-blue-600 text-white py-1.5 px-3 text-sm rounded">
              {{ loading['search'] ? 'Adding...' : 'Add Account' }}
            </button>
          </div>

          <div *ngIf="errorMessage" class="mt-2 text-sm text-red-400">
            {{ errorMessage }}
          </div>
        </div>

        <!-- Date Selection -->
        <div class="mt-4 bg-slate-800/95 rounded-lg shadow-lg p-4">
          <h2 class="text-xl font-bold text-white mb-4">Date</h2>
          <div class="grid grid-cols-2 gap-2">
            <select #monthSelect [value]="currentMonth" 
                    (change)="onDateSelect(monthSelect.value, daySelect.value)"
                    class="w-full px-2 py-1.5 text-sm bg-slate-700/95 text-white rounded border border-slate-600">
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <select #daySelect [value]="currentDay" 
                    (change)="onDateSelect(monthSelect.value, daySelect.value)"
                    class="w-full px-2 py-1.5 text-sm bg-slate-700/95 text-white rounded border border-slate-600">
              <option *ngFor="let day of getDaysForMonth(monthSelect.value)" [value]="day">{{day}}</option>
            </select>
          </div>
          <button (click)="loadAllFilteredActivities()"
                  class="w-full mt-2 bg-green-600 text-white py-1.5 px-3 text-sm rounded">
            Load Activities
          </button>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="col-span-12 lg:col-span-9">
        <app-loading-progress [progress]="loadingProgress"></app-loading-progress>
        
        <!-- Account Stats -->
        <div *ngIf="!loadingAccountStats && accountStats" 
             class="bg-slate-800/95 rounded-lg shadow-lg p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="stat-box">
              <div class="text-sm text-slate-400">Total Time</div>
              <div class="text-xl text-white">
                {{ (accountStats.totalTime / 60) | number:'1.0-0' }}h
              </div>
            </div>
            <div class="stat-box">
              <div class="text-sm text-slate-400">Activity Time</div>
              <div class="text-xl text-white">
                {{ (accountStats.totalActivityTime / 3600) | number:'1.0-0' }}h
              </div>
            </div>
            <div class="stat-box">
              <div class="text-sm text-slate-400">Activities</div>
              <div class="text-xl text-white">
                {{ accountStats.totalActivityCount }}
              </div>
            </div>
          </div>

          <!-- Guardian Firsts Section -->
          <div *ngIf="!loadingGuardianFirsts && guardianFirsts.length > 0" class="mt-6">
            <h3 class="text-lg font-semibold text-white mb-4">Guardian Firsts (Lifetime Overview)</h3>
            <div class="space-y-4">
              <div *ngFor="let game of guardianGames">
                <div *ngIf="hasGuardianFirstsForGame(game)">
                  <div class="text-md font-bold text-yellow-400 mb-2">
                    <span *ngIf="game === 'D1'">Destiny 1</span>
                    <span *ngIf="game === 'D2'">Destiny 2</span>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div *ngFor="let first of getGuardianFirstsForGame(game)" class="bg-slate-700/50 rounded-lg p-3 flex items-center justify-between">
                      <div class="flex items-center">
                        <img [src]="manifest.getActivityPgcrImage(first.referenceId, first.game === 'D1')" alt="{{ first.name }}" class="w-16 h-16 rounded mr-3 object-cover" />
                        <div>
                          <div class="flex items-center mb-1">
                            <img [src]="manifest.getActivityIcon(first.referenceId, first.game === 'D1')" alt="icon" class="w-5 h-5 mr-2" />
                            <span class="font-semibold text-white">{{ first.name }}</span>
                            <span class="ml-2 text-xs px-2 py-0.5 rounded bg-slate-600 text-slate-200 uppercase">{{ first.type }}</span>
                          </div>
                          <div class="text-sm text-slate-300">
                            {{ first.period | date:'medium' }}
                          </div>
                        </div>
                      </div>
                      <button (click)="viewPGCR(first.instanceId)" class="ml-4 px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700 transition">View PGCR</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Activities Grid -->
        <div *ngIf="!loadingActivities[selectedDate] && (groupedActivitiesByAccount && groupedActivitiesByAccount.length > 0)"
             class="space-y-6">
          <div *ngFor="let account of groupedActivitiesByAccount" 
               class="bg-slate-800/95 rounded-lg shadow-lg overflow-hidden">
            <div class="bg-slate-700/50 px-4 py-2 flex items-center">
              <h3 class="text-lg font-bold text-white">{{ account.displayName }}</h3>
              <span class="ml-2 px-2 py-0.5 text-sm rounded bg-slate-600 text-white">
                {{ account.platform }}
              </span>
            </div>
            
            <div class="p-4">
              <div *ngFor="let yearGroup of account.yearGroups" class="mb-6 last:mb-0">
                <h4 class="text-lg font-semibold text-white mb-4">{{ yearGroup.year }}</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div *ngFor="let activity of yearGroup.typeGroups[0].activities" 
                       class="activity-card bg-slate-700/50 rounded-lg overflow-hidden hover:bg-slate-700/70 transition-colors">
                    <div class="relative">
                      <img [src]="getActivityImage(activity, activity.game === 'D1') || activity.iconPath || getActivityTypeIcon(activity.activityDetails?.mode)"
                           [alt]="getActivityName(activity, activity.game === 'D1')"
                           class="w-full h-24 object-cover">
                      <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                      <div class="absolute bottom-0 left-0 right-0 p-3">
                        <h6 class="text-white font-medium truncate">
                          {{ getActivityName(activity, activity.game === 'D1') }}
                        </h6>
                        <div class="flex items-center justify-between text-sm text-slate-300">
                          <span>{{ formatTime(activity.period) }}</span>
                          <span>{{ getActivityDurationSeconds(activity) / 60 | number:'1.0-0' }}m</span>
                        </div>
                      </div>
                    </div>
                    <div class="p-3 border-t border-slate-600/50">
                      <button (click)="viewPGCR(activity.activityDetails?.instanceId)"
                              class="w-full text-center text-sm text-blue-400 hover:text-blue-300">
                        View Details
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loadingActivities[selectedDate]" 
             class="bg-slate-800/95 rounded-lg shadow-lg p-6 text-center">
          <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
          <p class="text-slate-300">Loading activities...</p>
        </div>

        <!-- No Activities State -->
        <div *ngIf="!loadingActivities[selectedDate] && (!groupedActivitiesByAccount || groupedActivitiesByAccount.length === 0)" 
             class="bg-slate-800/95 rounded-lg shadow-lg p-6 text-center text-slate-300">
          No activities found for this date.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Platform Picker Modal -->
<div *ngIf="showPlatformPicker" 
     class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold text-white mb-4">Select Platform</h3>
    <div class="space-y-2">
      <button *ngIf="crossSavePlayer" 
              (click)="selectPlatformPlayer(crossSavePlayer)"
              class="w-full bg-blue-600 text-white py-2 px-4 rounded text-sm">
        <span class="font-bold">Cross Save</span> ({{ crossSavePlayer.platform }})
      </button>
      <button *ngFor="let player of d2SearchResults" 
              (click)="selectPlatformPlayer(player)"
              class="w-full bg-slate-700 text-white py-2 px-4 rounded text-sm">
        {{ player.platform }} - {{ player.displayName }}
      </button>
    </div>
    <button (click)="showPlatformPicker = false"
            class="w-full mt-4 text-slate-400 hover:text-white text-sm">
      Cancel
    </button>
  </div>
</div>

<!-- Clear Activity Database Button -->
<div class="w-full flex justify-center mt-8">
  <button
    (click)="clearAllActivitiesFromDb()"
    class="px-4 py-2 bg-red-700 text-white rounded shadow hover:bg-red-800 transition text-xs"
    title="This will remove all stored activity data from your browser.">
    Clear Activity Database
  </button>
</div> 
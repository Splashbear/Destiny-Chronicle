<div class="search-container">
  <div class="search-boxes">
    <!-- D1 Xbox Search -->
    <div class="search-box">
      <h3>Destiny 1 Xbox Search</h3>
      <input
        type="text"
        [(ngModel)]="d1XboxSearchTerm"
        placeholder="Enter Xbox gamertag"
        (keyup.enter)="searchD1Player(d1XboxSearchTerm, 1)"
      />
      <button
        (click)="searchD1Player(d1XboxSearchTerm, 1)"
        [disabled]="loading['d1-xbox'] || !d1XboxSearchTerm"
      >
        {{ loading['d1-xbox'] ? 'Searching...' : 'Search' }}
      </button>
      <div *ngIf="error['d1-xbox']" class="error-message">
        {{ error['d1-xbox'] }}
      </div>
    </div>

    <!-- D1 PlayStation Search -->
    <div class="search-box">
      <h3>Destiny 1 PlayStation Search</h3>
      <input
        type="text"
        [(ngModel)]="d1PsnSearchTerm"
        placeholder="Enter PSN ID"
        (keyup.enter)="searchD1Player(d1PsnSearchTerm, 2)"
      />
      <button
        (click)="searchD1Player(d1PsnSearchTerm, 2)"
        [disabled]="loading['d1-psn'] || !d1PsnSearchTerm"
      >
        {{ loading['d1-psn'] ? 'Searching...' : 'Search' }}
      </button>
      <div *ngIf="error['d1-psn']" class="error-message">
        {{ error['d1-psn'] }}
      </div>
    </div>

    <!-- D2 Search -->
    <div class="search-box">
      <h3>Destiny 2 Search</h3>
      <input
        type="text"
        [(ngModel)]="d2SearchTerm"
        placeholder="Enter Bungie Name (e.g., Guardian#1234)"
        (keyup.enter)="searchD2Player(d2SearchTerm)"
      />
      <button
        (click)="searchD2Player(d2SearchTerm)"
        [disabled]="loading['d2'] || !d2SearchTerm"
      >
        {{ loading['d2'] ? 'Searching...' : 'Search' }}
      </button>
      <div *ngIf="error['d2']" class="error-message">
        {{ error['d2'] }}
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading['characters'] || loading['activities']" class="loading-indicator">
    Loading...
  </div>

  <!-- Selected Players -->
  <div *ngIf="selectedPlayers.length > 0" class="player-history">
    <h3>Selected Players</h3>
    <div class="selected-players">
      <div *ngFor="let player of selectedPlayers" class="player-card">
        <h4>
          {{ player.displayName }}
          <span class="game-version" [ngClass]="isD1Player(player) ? 'd1' : 'd2'">
            {{ isD1Player(player) ? 'D1' : 'D2' }}
          </span>
          <span *ngIf="player.isCrossSavePrimary" class="cross-save-indicator" title="Cross Save Primary Account" style="margin-left: 0.5em; vertical-align: middle;">
            <img src="https://www.bungie.net/img/theme/destiny/icons/icon_crosssave.svg" alt="Cross Save" style="height: 1em; vertical-align: middle;" />
          </span>
        </h4>
        <p class="platform">{{ getPlatformName(player.membershipType) }}</p>
      </div>
    </div>

    <!-- Date Filter -->
    <div class="date-filter">
      <label for="date">Filter by Date:</label>
      <input
        type="date"
        id="date"
        [(ngModel)]="selectedDate"
        (ngModelChange)="onDateChange($event)"
        (input)="onDateInput($event)"
        [disabled]="selectedPlayers.length === 0"
        placeholder="YYYY-MM-DD"
      />
      <small>Type or pick a date (YYYY-MM-DD)</small>
    </div>

    <!-- Activity History -->
    <div class="grouped-activities" *ngIf="selectedPlayers.length > 0 && selectedDate">
      <ng-container *ngIf="getGroupedYears().length === 0">
        <div class="no-activity-placeholder">
          <span class="tricorn-logo">ðŸŽ®</span>
          No activities found for this date
        </div>
      </ng-container>
      <ng-container *ngFor="let year of getGroupedYears()">
        <div class="year-section">
          <h2>{{ selectedDate | date:'MMMM d' }}, {{ year }}</h2>
          <ng-container *ngFor="let type of getGroupedTypes(year)">
            <ng-container *ngFor="let entry of getGroupedEntries(year, type)">
              <div class="activity-type-group">
                <div class="activity-header">
                  <span *ngIf="entry.game === 'D1'" class="tricorn-logo">ðŸŽ®</span>
                  <span *ngIf="entry.game === 'D2'" class="tricorn-logo">ðŸŸª</span>
                  <strong>{{ entry.game === 'D1' ? 'Destiny 1' : 'Destiny 2' }}</strong> -
                  <span>{{ type }}</span>
                  <span>({{ entry.platform }})</span>
                  <span>- {{ entry.player.displayName }}</span>
                </div>
                <div *ngFor="let activity of entry.activities" class="activity-card">
                  <div class="activity-info">
                    <h4>
                      <img *ngIf="manifest.getActivityIcon(activity.activityDetails?.referenceId)" 
                           [src]="manifest.getActivityIcon(activity.activityDetails?.referenceId)" 
                           alt="" style="height: 1em; vertical-align: middle; margin-right: 0.5em;">
                      {{ manifest.getActivityName(activity.activityDetails?.referenceId) || 'Unknown Activity' }}
                    </h4>
                    <p>{{ activity.values?.kills?.basic?.displayValue }} Kills</p>
                    <p>{{ activity.values?.deaths?.basic?.displayValue }} Deaths</p>
                    <p>{{ activity.values?.killsDeathsRatio?.basic?.displayValue }} K/D</p>
                  </div>
                  <button (click)="viewPGCR(activity.activityDetails.instanceId)">
                    View Details
                  </button>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>
    </div>
  </div>
</div> 
<div class="search-container">
  <div class="search-boxes">
    <!-- D1 Xbox Search -->
    <div class="search-box">
      <h3>Destiny 1 Xbox Search</h3>
      <input
        type="text"
        [(ngModel)]="d1XboxSearchTerm"
        placeholder="Enter Xbox gamertag"
        (keyup.enter)="searchD1Player(d1XboxSearchTerm, 1)"
      />
      <button
        (click)="searchD1Player(d1XboxSearchTerm, 1)"
        [disabled]="loading['d1-xbox'] || !d1XboxSearchTerm"
      >
        {{ loading['d1-xbox'] ? 'Searching...' : 'Search' }}
      </button>
      <div *ngIf="error['d1-xbox']" class="error-message">
        {{ error['d1-xbox'] }}
      </div>
    </div>

    <!-- D1 PlayStation Search -->
    <div class="search-box">
      <h3>Destiny 1 PlayStation Search</h3>
      <input
        type="text"
        [(ngModel)]="d1PsnSearchTerm"
        placeholder="Enter PSN ID"
        (keyup.enter)="searchD1Player(d1PsnSearchTerm, 2)"
      />
      <button
        (click)="searchD1Player(d1PsnSearchTerm, 2)"
        [disabled]="loading['d1-psn'] || !d1PsnSearchTerm"
      >
        {{ loading['d1-psn'] ? 'Searching...' : 'Search' }}
      </button>
      <div *ngIf="error['d1-psn']" class="error-message">
        {{ error['d1-psn'] }}
      </div>
    </div>

    <!-- D2 Search -->
    <div class="search-box">
      <h3>Destiny 2 Search</h3>
      <input
        type="text"
        [(ngModel)]="d2SearchTerm"
        placeholder="Enter Bungie Name (e.g., Guardian#1234)"
        (keyup.enter)="searchD2Player(d2SearchTerm)"
      />
      <button
        (click)="searchD2Player(d2SearchTerm)"
        [disabled]="loading['d2'] || !d2SearchTerm"
      >
        {{ loading['d2'] ? 'Searching...' : 'Search' }}
      </button>
      <div *ngIf="error['d2']" class="error-message">
        {{ error['d2'] }}
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading['characters'] || loading['activities']" class="loading-indicator">
    Loading...
  </div>

  <!-- Selected Players -->
  <div *ngIf="selectedPlayers.length > 0" class="player-history">
    <h3>Selected Players</h3>
    <div class="selected-players">
      <div *ngFor="let player of selectedPlayers" class="player-card">
        <h4>
          {{ player.displayName }}
          <span class="game-version" [ngClass]="isD1Player(player) ? 'd1' : 'd2'">
            {{ isD1Player(player) ? 'D1' : 'D2' }}
          </span>
          <span *ngIf="player.isCrossSavePrimary" class="cross-save-indicator" title="Cross Save Primary Account" style="margin-left: 0.5em; vertical-align: middle;">
            <img src="https://www.bungie.net/img/theme/destiny/icons/icon_crosssave.svg" alt="Cross Save" style="height: 1em; vertical-align: middle;" />
          </span>
        </h4>
        <p class="platform">{{ getPlatformName(player.membershipType) }}</p>
      </div>
    </div>

    <!-- Date Filter -->
    <div class="date-filter">
      <label for="date">Filter by Date:</label>
      <input
        type="date"
        id="date"
        [(ngModel)]="selectedDate"
        (ngModelChange)="onDateChange($event)"
        (input)="onDateInput($event)"
        [disabled]="selectedPlayers.length === 0"
        placeholder="YYYY-MM-DD"
      />
      <small>Type or pick a date (YYYY-MM-DD)</small>
    </div>

    <!-- Activity Type Filter Dropdown -->
    <div class="activity-type-filter">
      <label for="activityTypeSelect">Activity Type:</label>
      <select id="activityTypeSelect" [(ngModel)]="selectedActivityType" (change)="onActivityTypeChange($event)">
        <option *ngFor="let type of activityTypeOptions" [ngValue]="type">{{ type.label }}</option>
      </select>
    </div>

    <!-- Activity History -->
    <div class="activity-history" *ngIf="selectedPlayers.length > 0 && selectedDate">
      <!-- Date Header -->
      <div class="date-header">
        <h2>{{ selectedDate | date:'MMMM d' }} Activities</h2>
      </div>

      <!-- Activity List -->
      <div class="activity-list">
        <ng-container *ngFor="let yearGroup of getGroupedActivitiesByYearAndType()">
          <!-- Year Section -->
          <div class="year-section">
            <h3 class="year-header">{{ yearGroup.year }}</h3>
            
            <ng-container *ngFor="let activityType of getGroupedTypes(yearGroup.year)">
              <!-- Activity Type Group -->
              <div class="activity-type-group">
                <div class="activity-type-header">
                  <img [src]="getActivityTypeIcon(activityType)" 
                       alt="" 
                       class="activity-icon"
                       onerror="this.src='assets/icons/activity.png'">
                  <span class="activity-type-name">{{ activityType }}</span>
                </div>

                <ng-container *ngFor="let entry of getGroupedEntries(yearGroup.year, activityType)">
                  <!-- Game/Platform Indicator -->
                  <div class="game-platform-indicator">
                    <span class="game-badge" [ngClass]="entry.game.toLowerCase()">
                      {{ entry.game }}
                    </span>
                    <span class="platform-badge">
                      {{ entry.platform }}
                    </span>
                    <span class="player-name">{{ entry.player.displayName }}</span>
                  </div>

                  <!-- Activities -->
                  <div class="activity-cards">
                    <div class="activity-card" *ngFor="let activity of getFilteredActivities(entry.activities, entry.game)">
                      <!-- Activity Header -->
                      <div class="activity-header">
                        <img [src]="manifest.getActivityIcon(activity.activityDetails.referenceId || '', entry.game === 'D1')"
                             [alt]="manifest.getActivityName(activity.activityDetails.referenceId || '', entry.game === 'D1')"
                             class="activity-icon">
                        <div class="activity-info">
                          <div class="activity-name">
                            {{ manifest.getActivityName(activity.activityDetails.referenceId || '', entry.game === 'D1') || 'Unknown Activity' }}
                          </div>
                          <div class="activity-stats">
                            <div class="stat">
                              <span class="stat-label">K/D/A</span>
                              <span class="stat-value">
                                {{ activity.values.kills?.basic?.value || 0 }}/{{ activity.values.deaths?.basic?.value || 0 }}/{{ activity.values.assists?.basic?.value || 0 }}
                              </span>
                            </div>
                            <div class="stat">
                              <span class="stat-label">Score</span>
                              <span class="stat-value">{{ activity.values.score?.basic?.value || 0 | number }}</span>
                            </div>
                            <div class="stat">
                              <span class="stat-label">Time</span>
                              <span class="stat-value">{{ formatTime(activity.values.timePlayedSeconds?.basic?.value || 0) }}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- View Details Button -->
                      <button class="view-details-btn" (click)="viewPGCR(activity.activityDetails.instanceId || '')">
                        View Details
                      </button>
                    </div>
                  </div>
                </ng-container>
              </div>
            </ng-container>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- PGCR Modal -->
<div class="modal-overlay" *ngIf="showPGCRModal" (click)="closePGCRModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-button" (click)="closePGCRModal()">Ã—</button>
    <app-pgcr-details [pgcr]="selectedPGCR"></app-pgcr-details>
  </div>
</div> 